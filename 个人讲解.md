我大学毕业设计是关于unity2d游戏开发的，游戏主要内容是对宝可梦游戏复刻，类型是有关宠物养成类的。在游戏的制作中，我遇到了许多问题，很多都在思考过后得出了解决方案。

>关于算法方面，我使用了A*寻路算法，和dijstra算法，A*算法寻路算法主要是dijstra和一个Best First算法的结合，通过到该点路径+该点到目标的的曼哈顿距离作为路径长度衡量，原本dijstra的存储到该点路径最小值变成路径长度衡量函数最小值，它像dijstra一样需要记录父节点，该算法有open集合和close集合，每次加入一个新的点，遍历其周围的点，如果不在open集合和close集合，一一加入open集合，同时选择open集合中衡量函数最小值加入close集合，当找到终点时，返回逆向路径。原本一开始，我按整张地图进行A*算法，每个城镇都有一个中心建筑坐标，计算玩家与该中心坐标的最短路径，其中A*通过一个格子类和一个A*控制器控制，格子类主要记录该格子的格子转化坐标，格子枚举类别，是否在open集合和是否在close集合，等等，后来我发现这样运算有点卡顿，于是我吧原本顺序查找改为建立小根堆，在小根堆中查找最小值。但是后来我发现，我根本不需要整张地图进行采样，因为手机的屏幕很小，所以在玩家界面根本不需要寻路需求，只有在小地图上玩家才会选择城镇进行寻路系统，那么事情就变得简单了，由于2.5d平面游戏的每一个城镇或地形的对应的出入口只有10个以内，那么我只需要对玩家到出入口的地方进行实时寻路，对城镇间的路径使用玩a*寻路后记录下来，对城镇间的最短距离使用dijstra算法。那么当玩家处于某个城镇的某处点击小地图上的某个城镇进行寻路时，只需对该城镇大小地图采样，寻路，再根据城镇间的最短dijstra路径找到途径城镇，再读取存储好的城镇间最短a*路径即可实现寻路。
>
>

> 比如关于数据库方面的，游戏使用的是sqlite轻量级数据库，由于本游戏作为成熟游戏的复刻，数据表众多，如何读取不同结构的表数据是一个问题。一般的方法是，创建一个接口增删改查，一个表对应一个类实现该接口，使用的人需要调用其类对应的接口。可这样做的话耦合度太高。我在想能否使用一个函数，不管处理的是什么表，都可以进行处理，我想到了泛型的概念，使用泛型的确可以根据函数调用类型的不同来返回不同类型，可是获取该类型内部信息呢？我想到了反射，使用反射可以获得内部信息，于是我创建一个继承Attribute特性的类来标记每一属性，包含是否主键，表项名字特性包含类型等等的信息，使用反射获取对应属性的对应特性来辨别对象，使用一个sqlite插件提供的查询信息对比其表项名和特性是否一致， 使用Activator.CreateInstance<T>()来创建对象。

> 比如关于战斗界面方面，其包含宠物背包的视图处理，小背包视图处理，动画处理，对话框处理，由于战斗界面需要查询数据库中许多参数并且对其根据公式进行一系列计算判定，而且动画与对话框顺序是由代码控制的，其界面交互复杂，为了解决视图和数据库逻辑的耦合度高，代码混乱，我参考了MVC模式的变化版本MVP模式，model-view-presenter，model层即书库逻辑层不再与view层交互，而是以presenter层为桥梁，view层提供一个view接口给p层调用，一定程度上降低了代码的耦合度，该模式缺点是presenter与view层结合紧密，难以复用。

> 比如在控制器方面，由于事实上一个场景中控制器只有一个。一般调用控制器都需要新建一个，才能调用其内部函数，这非常不合理，对此我采用单例模式，创建了一个单例泛型类内部新建一个静态对象存储控制器对象，凡是单例的类都继承该泛型类，则调用时只需使用该类的静态对象即可调用内部函数。

> 比如在渲染方面，由于我的游戏界面是一张背景图，加上各种的空碰撞体，加上我的游戏是2d仿3d效果，xy都能走，于是我的人物如果不处理等于走在了图片上，非常难看，其中我需要走进草丛，草丛摇晃的效果，需要走到屋顶被遮挡效果，需要走到水潭边有倒影效果，首先我想到了使用shader进行着色处理，对于遮挡的部分不予渲染，实际上就是需要一张二值黑白图像，在做片源渲染的时候告诉着色器在黑色像素内的不需要渲染，像素外的需要渲染，幸运的是unity提供了一个mask渲染器，我可以方便地实现该功能，对于草丛抖动效果我给了4长小形的二值草丛遮挡图，当人物移动一格的时候随机切换mask渲染器的图片，在视觉上实现了走动草丛动的效果，对于场景的需要遮挡的部分我给予了一张大的遮挡二值图实现屋顶树顶遮挡效果，对于倒影，我编写了一个shader，理想打算是打开a通道，新建一个小图片对人物当前sprite图片的texture拷贝副本，在其着色时修改对应的uv的值，将y值由0-1变为1-0实现反转，然后设定对应的a透明度实现简单倒影效果，但由于我的图片时图集所以得到的texture也是图集，我需要先根据unity提供的uv坐标和宽高截取图集一部分，新建一个texture才能实现效果。

> 最近我也在b站学习图形学，实现了透视投影，光栅化，和简单的blinn-phong模型。其中顶点的信息通过obj文件读取，v代表空间坐标vt代表uv坐标，vn代表该点法向量，f后有三个点每个点的三项分别v/vt/vn索引，使用了Gouraudshader根据三角形的三个点的颜色根据重心坐标插值，由于a,b,y是屏幕坐标上需要进行矫正，对应的深度，uv坐标，三点法线进行插值，环境光设定为恒定值，根据三角形对应变换前的三个三维坐标点用修正后的a，b，y进行插值，找出观测点，计算其与发光点距离，根据观测点到相机的方向向量与观测点到光源的方向向量计算半程向量，通过多次余弦函数计算它与插值法向量是否靠近，代入公式，实现了环境光+漫反射+高光的blinn-phong模型。用对应的texture的颜色代替漫反射的kd则实现了带纹理的blinn-phong模型。使用opencv内的Mat构建一个三通道rgb图像，由于opencv支持BGR,所以要使用Cvtcolor函数把图片从rgb转化为BGR格式，最后用imwrite导出图片。